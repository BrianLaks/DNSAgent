@page "/admin/reports"
@using Microsoft.EntityFrameworkCore
@using DNSAgent.Service.Data
@inject DnsDbContext Db
@inject IJSRuntime JSRuntime
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<PageTitle>System Reports - DNS Agent</PageTitle>

<div class="container-fluid mt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>ðŸ“Š System Analytics</h1>
            <p class="text-muted">Deep dive into network traffic and blocking performance</p>
        </div>
        <div>
            <button class="btn btn-outline-primary" @onclick="LoadData">
                <span class="bi bi-arrow-repeat"></span> Refresh Data
            </button>
        </div>
    </div>

    <div class="row">
        <!-- traffic trend -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Network Traffic (7 Days)</h5>
                </div>
                <div class="card-body">
                    <div id="trafficTrendChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
        <!-- Top Devices Chart -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Device Volume (24h)</h5>
                </div>
                <div class="card-body">
                    <div id="deviceVolumeChart" style="height: 350px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Security distribution -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Security Profile</h5>
                </div>
                <div class="card-body">
                    <div id="securityPieChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- YouTube Blocking Trend -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">YouTube Protection Trends</h5>
                </div>
                <div class="card-body">
                    <div id="youtubeTrendChart" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    <div class="row">
        <!-- Top Devices Table -->
        <div class="col-lg-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Top Devices by Volume (24h)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="bg-light">
                                <tr>
                                    <th>Machine Name</th>
                                    <th>IP Address</th>
                                    <th>Queries</th>
                                    <th>Blocked</th>
                                    <th>Protection Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var device in topDevices)
                                {
                                    <tr>
                                        <td><strong>@device.Name</strong></td>
                                        <td><code>@device.IP</code></td>
                                        <td>@device.Count</td>
                                        <td><span class="text-danger">@device.Blocked</span></td>
                                        <td>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-success" style="width: @(device.Count == 0 ? 0 : (double)device.Blocked/device.Count*100)%"></div>
                                            </div>
                                            <small class="text-muted">@((device.Count == 0 ? 0 : (double)device.Blocked/device.Count*100).ToString("0.0"))% blocked</small>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

@code {
    private List<DeviceStat> topDevices = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!isLoading)
        {
            await RenderCharts();
        }
    }

    private async Task LoadData()
    {
        isLoading = true;
        try 
        {
            // 7 Day Traffic Trend
            var weekAgo = DateTime.Now.Date.AddDays(-6);
            var logs = await Db.QueryLogs
                .Where(x => x.Timestamp >= weekAgo)
                .Select(x => new { x.Timestamp, x.IsDnssec })
                .ToListAsync();

            var trafficTrend = logs.GroupBy(x => x.Timestamp.Date)
                .OrderBy(g => g.Key)
                .Select(g => new { Label = g.Key.ToString("MM/dd"), Count = g.Count() })
                .ToList();

            var trafficLabels = trafficTrend.Select(x => x.Label).ToArray();
            var trafficData = trafficTrend.Select(x => x.Count).ToArray();

            // YouTube Trends (7 days)
            var ytStats = await Db.YouTubeStats
                .Where(x => x.Timestamp >= weekAgo)
                .ToListAsync();
            
            var ytTrend = ytStats.GroupBy(x => x.Timestamp.Date)
                .OrderBy(g => g.Key)
                .Select(g => new { 
                    Label = g.Key.ToString("MM/dd"), 
                    Ads = g.Sum(s => s.AdsBlocked), 
                    Sponsors = g.Sum(s => s.SponsorsSkipped) 
                })
                .ToList();

            var ytLabels = ytTrend.Select(x => x.Label).ToArray();
            var adsData = ytTrend.Select(x => x.Ads).ToArray();
            var sponsorsData = ytTrend.Select(x => x.Sponsors).ToArray();

            // Security Profile
            var securityLabels = new[] { "DNSSEC", "Standard" };
            var securityData = new[] { 
                logs.Count(x => x.IsDnssec), 
                logs.Count(x => !x.IsDnssec) 
            };

            // Top Devices for last 24h
            var dayAgo = DateTime.Now.AddHours(-24);
            topDevices = await Db.QueryLogs
                .Where(x => x.Timestamp >= dayAgo)
                .GroupBy(l => l.SourceIP)
                .Select(g => new DeviceStat {
                    IP = g.Key,
                    Count = g.Count(),
                    Blocked = g.Count(x => x.Status == "Blocked")
                })
                .OrderByDescending(x => x.Count)
                .Take(10)
                .ToListAsync();

            foreach(var d in topDevices) {
                var device = await Db.Devices.FirstOrDefaultAsync(x => x.LastIP == d.IP);
                if (device != null) d.Name = device.MachineName;
            }

            var deviceLabels = topDevices.Select(x => x.Name).ToArray();
            var deviceCounts = topDevices.Select(x => x.Count).ToArray();

            isLoading = false;
            await JSRuntime.InvokeVoidAsync("renderDetailedReports", 
                trafficLabels, trafficData, 
                ytLabels, adsData, sponsorsData, 
                securityLabels, securityData,
                deviceLabels, deviceCounts);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task RenderCharts() { } // Handled in LoadData for now

    class DeviceStat {
        public string IP { get; set; } = "";
        public string Name { get; set; } = "Unknown";
        public int Count { get; set; }
        public int Blocked { get; set; }
    }
}
