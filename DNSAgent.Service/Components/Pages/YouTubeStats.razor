@page "/admin/youtube-stats"
@using Microsoft.EntityFrameworkCore
@using DNSAgent.Service.Data
@using DNSAgent.Service.Configuration
@inject DnsDbContext Db
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<PageTitle>YouTube Insights - DNS Agent</PageTitle>

<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1>üéØ YouTube Personal Insights</h1>
        <p class="subtitle">Ad-blocking transparency & your local watch data</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-outline-danger me-2" @onclick="PurgeHistory">
            <span class="bi bi-trash"></span> Purge History
        </button>
        <button class="btn btn-outline-primary" @onclick="RefreshData">
            <span class="bi bi-arrow-repeat"></span> Refresh
        </button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon text-success">üõ°Ô∏è</div>
        <div class="stat-value">@totalAdsBlocked</div>
        <div class="stat-label">Total Ads Neutralized</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon text-info">‚ö°</div>
        <div class="stat-value">@totalSponsorsSkipped</div>
        <div class="stat-label">Sponsors Skipped</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon text-primary">‚è±Ô∏è</div>
        <div class="stat-value">@FormatTime(totalTimeSaved)</div>
        <div class="stat-label">Human Time Saved</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon text-warning">üìñ</div>
        <div class="stat-value">@watchHistory.Count</div>
        <div class="stat-label">Videos in Local History</div>
    </div>
</div>

<ul class="nav nav-tabs mb-4 px-3">
    <li class="nav-item">
        <button class="nav-link @(activeTab == "history" ? "active" : "")" @onclick='() => SetTab("history")'>
            <i class="bi bi-clock-history me-1"></i> Insights
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link @(activeTab == "profiles" ? "active" : "")" @onclick='() => SetTab("profiles")'>
            <i class="bi bi-people me-1"></i> Profile Management
        </button>
    </li>
</ul>

@if (activeTab == "history")
{
<div class="row">
    <div class="col-lg-8">
        <div class="section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>üì∫ Your Watch Activity (Local)</h2>
                <div class="search-box">
                     <input type="text" class="form-control" placeholder="Search your history..." @bind="historyFilter" @bind:event="oninput" />
                </div>
            </div>
            
            <div class="activity-log activity-table-container">
                @if (filteredHistory.Any())
                {
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Source</th>
                                <th>Profile</th>
                                <th>Video Title</th>
                                <th>Channel</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var activity in filteredHistory)
                            {
                                <tr>
                                    <td class="small-timestamp">@activity.Timestamp.ToLocalTime().ToString("g")</td>
                                    <td>
                                        @if (activity.DeviceName?.StartsWith("Proxy") == true)
                                        {
                                            <span class="badge bg-secondary" title="@activity.DeviceName">üì∫ TV/Proxy</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-info" title="@activity.DeviceName">üåê Browser</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="small @(activity.YouTubeHandle == "[Proxy Captured]" ? "text-warning" : "text-primary fw-bold")">
                                            @activity.YouTubeHandle
                                        </span>
                                        @if (activity.YouTubeHandle == "[Proxy Captured]" && activity.DeviceName?.StartsWith("Proxy:") == true)
                                        {
                                            <button class="btn btn-link btn-sm p-0 ms-1" @onclick='() => { activeTab = "profiles"; newMappingIp = activity.DeviceName.Replace("Proxy: ", ""); }' title="Map this device">
                                                <i class="bi bi-plus-circle"></i>
                                            </button>
                                        }
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 300px;">
                                            <a href="https://youtube.com/watch?v=@activity.VideoId" target="_blank" class="video-link">@activity.Title</a>
                                        </div>
                                    </td>
                                    <td><strong>@activity.Channel</strong></td>
                                    <td>@FormatDuration(activity.DurationSeconds)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="empty-state">
                        <p>üì≠ No watch activity recorded</p>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="section">
            <h2>üèÜ Top Channels</h2>
            <div class="top-channels">
                @foreach (var channel in topChannels)
                {
                    <div class="channel-card d-flex justify-content-between align-items-center p-2 mb-2 border-bottom">
                        <div class="channel-name">@channel.Name</div>
                        <div class="channel-count badge bg-primary">@channel.Count videos</div>
                    </div>
                }
            </div>
        </div>

        <div class="section mt-4">
            <h2>üõ°Ô∏è Latest Ad Blocks</h2>
            <div class="ad-events-mini">
                @foreach (var ad in recentAdEvents)
                {
                    <div class="ad-event-item p-2 border-start border-4 @GetBorderClass(ad.AdType) mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">@ad.AdType</span>
                            <span class="small text-muted">@ad.Timestamp.ToLocalTime().ToString("HH:mm")</span>
                        </div>
                        <div class="small">Action: @ad.ActionTaken</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
}
else
{
    <div class="section">
                <div class="row">
                    <div class="col-md-7">
                        <h2>üë• Profile Mappings</h2>
                        <p class="small text-muted mb-4">Assign names to IPs captured from SmartTube/TV devices. This isolates history for different family members.</p>
                        
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Device IP</th>
                                    <th>YouTube Profile</th>
                                    <th>Last Activity</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var mapping in profileMappings)
                                {
                                    <tr>
                                        <td><code>@mapping.DeviceIdentifier</code></td>
                                        <td><span class="badge bg-primary">@mapping.YouTubeHandle</span></td>
                                        <td class="small-timestamp">@mapping.LastUsed.ToLocalTime().ToString("g")</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteMapping(mapping.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                                @if (!profileMappings.Any())
                                {
                                    <tr><td colspan="4" class="text-center py-4 text-muted">No mappings defined yet.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-5 border-start ps-4">
                        <h4>Create New Mapping</h4>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Device IP Address</label>
                            <input type="text" class="form-control" @bind="newMappingIp" placeholder="e.g. 192.168.1.50" />
                            @if (unmappedDevices.Any())
                            {
                                <div class="mt-2">
                                    <small class="text-muted">Detected unmapped proxy devices:</small>
                                    <div class="d-flex flex-wrap gap-2 mt-1">
                                        @foreach (var ip in unmappedDevicesList)
                                        {
                                            <button class="btn btn-sm btn-light" @onclick='() => newMappingIp = ip'>@ip</button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">YouTube Profile Handle</label>
                            <input type="text" class="form-control" @bind="newMappingHandle" placeholder="e.g. @@brianlaks" />
                            <div class="form-text">This name MUST match the handle shown in history for shared re-ranking.</div>
                        </div>
                        <button class="btn btn-primary w-100" @onclick="SaveMapping">
                            <i class="bi bi-save me-1"></i> Save Association
                        </button>
                        
                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <div class="alert alert-info mt-3 small">@statusMessage</div>
                        }
                    </div>
                </div>
            </div>
}

@code {
    private int totalAdsBlocked = 0;
    private int totalSponsorsSkipped = 0;
    private double totalTimeSaved = 0;
    private string serverVersion = $"v{Constants.AppVersion}";
    
    private List<YouTubeActivity> watchHistory = new();
    private List<YouTubeAdEvent> recentAdEvents = new();
    private List<ChannelStat> topChannels = new();
    
    private string historyFilter = "";
    private List<YouTubeActivity> filteredHistory => string.IsNullOrWhiteSpace(historyFilter) 
        ? watchHistory 
        : watchHistory.Where(x => x.Title.Contains(historyFilter, StringComparison.OrdinalIgnoreCase) || x.Channel.Contains(historyFilter, StringComparison.OrdinalIgnoreCase)).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task RefreshData()
    {
        await LoadData();
        StateHasChanged();
    }

    private async Task PurgeHistory()
    {
        Db.YouTubeActivities.RemoveRange(Db.YouTubeActivities);
        Db.YouTubeAdEvents.RemoveRange(Db.YouTubeAdEvents);
        await Db.SaveChangesAsync();
        await LoadData();
        statusMessage = "All YouTube history and ad events purged.";
        StateHasChanged();
    }

    private async Task LoadData()
    {
        totalAdsBlocked = await Db.YouTubeAdEvents.CountAsync(e => e.ActionTaken == "Skipped" || e.ActionTaken == "Blocked");
        totalSponsorsSkipped = await Db.YouTubeAdEvents.CountAsync(e => e.AdType == "SponsorBlock");
        
        // Sum from aggregate stats as well if needed, but let's prioritize new granular events
        var legacyStats = await Db.YouTubeStats.ToListAsync();
        totalAdsBlocked += legacyStats.Sum(s => s.AdsBlocked);
        totalSponsorsSkipped += legacyStats.Sum(s => s.SponsorsSkipped);
        totalTimeSaved = legacyStats.Sum(s => s.TimeSavedSeconds);

        watchHistory = await Db.YouTubeActivities.OrderByDescending(x => x.Timestamp).Take(200).ToListAsync();
        recentAdEvents = await Db.YouTubeAdEvents.OrderByDescending(x => x.Timestamp).Take(50).ToListAsync();

        topChannels = watchHistory.GroupBy(x => x.Channel)
            .Select(g => new ChannelStat { Name = g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(10)
            .ToList();

        profileMappings = await Db.YouTubeProfileMappings.OrderByDescending(m => m.LastUsed).ToListAsync();
        
        var mappedIps = profileMappings.Select(m => m.DeviceIdentifier).ToList();
        unmappedDevices = await Db.YouTubeActivities
            .Where(a => a.DeviceName.StartsWith("Proxy:"))
            .OrderByDescending(a => a.Timestamp)
            .Take(500)
            .ToListAsync();
        
        unmappedDevicesDetect = unmappedDevices
            .Select(a => a.DeviceName.Replace("Proxy: ", ""))
            .Distinct()
            .Where(ip => !mappedIps.Contains(ip))
            .ToList();
    }

    private string activeTab = "history";
    private List<YouTubeProfileMapping> profileMappings = new();
    private List<string> unmappedDevicesDetect = new();
    private List<YouTubeActivity> unmappedDevices = new(); // Used for intermediate query
    private List<string> unmappedDevicesList => unmappedDevicesDetect;

    private string newMappingIp = "";
    private string newMappingHandle = "";
    private string statusMessage = "";

    private void SetTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    private async Task SaveMapping()
    {
        if (string.IsNullOrEmpty(newMappingIp) || string.IsNullOrEmpty(newMappingHandle)) return;

        var existing = await Db.YouTubeProfileMappings
            .FirstOrDefaultAsync(m => m.DeviceIdentifier == newMappingIp);

        if (existing != null)
        {
            existing.YouTubeHandle = newMappingHandle;
            existing.LastUsed = DateTime.UtcNow;
        }
        else
        {
            Db.YouTubeProfileMappings.Add(new YouTubeProfileMapping
            {
                DeviceIdentifier = newMappingIp,
                YouTubeHandle = newMappingHandle,
                LastUsed = DateTime.UtcNow
            });
        }

        await Db.SaveChangesAsync();
        newMappingIp = "";
        newMappingHandle = "";
        statusMessage = "Mapping saved successfully!";
        await LoadData();
    }

    private async Task DeleteMapping(int id)
    {
        var mapping = await Db.YouTubeProfileMappings.FindAsync(id);
        if (mapping != null)
        {
            Db.YouTubeProfileMappings.Remove(mapping);
            await Db.SaveChangesAsync();
            await LoadData();
        }
    }

    private void QuickMap(string ip)
    {
        activeTab = "profiles";
        newMappingIp = ip;
        StateHasChanged();
    }

    private string FormatTime(double seconds)
    {
        if (seconds < 60) return $"{seconds:F0}s";
        if (seconds < 3600) return $"{seconds / 60:F1}m";
        if (seconds < 86400) return $"{seconds / 3600:F1}h";
        return $"{seconds / 86400:F1}d";
    }

    private string FormatDuration(double seconds)
    {
        var t = TimeSpan.FromSeconds(seconds);
        return t.TotalHours >= 1 ? t.ToString(@"h\:mm\:ss") : t.ToString(@"m\:ss");
    }

    private string GetBorderClass(string adType)
    {
        return adType switch
        {
            "SponsorBlock" => "border-info",
            "SkipButton" => "border-success",
            "PlayerMonitor" => "border-warning",
            _ => "border-primary"
        };
    }

    class ChannelStat
    {
        public string Name { get; set; } = "";
        public int Count { get; set; }
    }
}

<style>
    .page-header h1 { margin-bottom: 0; }
    .subtitle { opacity: 0.7; margin-top: 4px; }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
        margin-top: 20px;
    }

    .stat-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #eee);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .stat-icon { font-size: 32px; margin-bottom: 10px; }
    .stat-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
    .stat-label { font-size: 14px; opacity: 0.7; font-weight: 500; }

    .section {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #eee);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        height: 100%;
    }

    .section h2 { font-size: 1.25rem; margin-bottom: 20px; font-weight: 600; }

    .activity-table-container {
        max-height: 600px;
        overflow-y: auto;
    }

    .stats-table {
        width: 100%;
        border-collapse: collapse;
    }

    .stats-table th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #eee;
        z-index: 10;
        font-size: 0.85rem;
        text-transform: uppercase;
        color: #666;
    }

    .stats-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem;
    }

    .small-timestamp { font-size: 0.75rem; color: #888; }
    .video-link { color: #0078d4; text-decoration: none; font-weight: 500; }
    .video-link:hover { text-decoration: underline; }

    .ad-event-item {
        background: #f9f9f9;
        border-radius: 4px;
        transition: transform 0.2s;
    }
    .ad-event-item:hover { transform: translateX(5px); }

    .channel-card:last-child { border-bottom: none; }
    .channel-name { font-weight: 500; }

    .search-box .form-control {
        border-radius: 20px;
        padding-left: 15px;
        font-size: 0.9rem;
        width: 250px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
</style>
