@page "/logs"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]
@using DNSAgent.Service.Data
@using DNSAgent.Service.Services
@using Microsoft.EntityFrameworkCore
@inject DnsDbContext Db
@inject DnsWorker DnsWorker
@inject NavigationManager Nav

<PageTitle>Query Logs - DNS Agent</PageTitle>

<div class="container mt-4">
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1>Query Logs @(string.IsNullOrEmpty(SearchIP) ? "" : $"for {SearchIP}")</h1>
            <p class="text-muted">Last 100 queries processed by the server</p>
        </div>
        <div class="col-auto d-flex gap-2 flex-wrap align-items-center">
            <div class="d-flex align-items-center gap-1">
                <span class="small text-muted">From:</span>
                <input type="date" class="form-control form-control-sm w-auto" @bind="StartDate" />
            </div>
            <div class="d-flex align-items-center gap-1">
                <span class="small text-muted">To:</span>
                <input type="date" class="form-control form-control-sm w-auto" @bind="EndDate" />
            </div>
            <select class="form-select form-select-sm w-auto" @bind="StatusFilter">
                <option value="All">All Statuses</option>
                <option value="Blocked">Blocked Only</option>
                <option value="Allowed">Allowed Only</option>
            </select>
            <div class="input-group input-group-sm w-auto">
                <span class="input-group-text bg-white border-end-0"><span class="bi bi-search"></span></span>
                <input type="text" class="form-control border-start-0" placeholder="Search domain..." @bind="SearchTerm" @onkeyup="HandleKeyUp" />
            </div>
            <button class="btn btn-sm btn-primary d-flex align-items-center" @onclick="LoadLogs">
                <span class="bi bi-arrow-repeat me-1"></span> Refresh
            </button>
            <button class="btn btn-sm btn-outline-danger d-flex align-items-center" @onclick="ClearLogs">
                <span class="bi bi-trash me-1"></span> Clear
            </button>
        </div>
    </div>

    @if (logs == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover shadow-sm">
                <thead>
                    <tr class="table-primary text-white">
                        <th>Time</th>
                        <th>Device / User</th>
                        <th>Domain</th>
                        <th>Transport</th>
                        <th>Security</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var log in logs)
                    {
                        <tr class="@GetRowClass(log.Status)">
                            <td>@log.Timestamp.ToString("HH:mm:ss")</td>
                            <td>
                                @{
                                    devices.TryGetValue(log.ClientId ?? "", out var d);
                                    var displayName = d != null ? $"{d.MachineName} ({d.UserName})" : log.SourceIP;
                                }
                                <div><strong>@displayName</strong></div>
                                @if (d != null && d.LastIP != log.SourceIP)
                                {
                                    <small class="text-muted">@log.SourceIP</small>
                                }
                                else if (d == null && !string.IsNullOrEmpty(log.SourceHostname) && log.SourceHostname != log.SourceIP)
                                {
                                    <small class="text-muted">@log.SourceHostname</small>
                                }
                            </td>
                            <td><code class="text-dark" title="@log.Domain">@log.Domain</code></td>
                            <td>
                                <span class="badge @(log.Transport == "DoH" ? "bg-info" : "bg-secondary")">
                                    <span class="bi @(log.Transport == "DoH" ? "bi-lock" : "bi-unlock") me-1"></span>
                                    @log.Transport
                                </span>
                            </td>
                            <td>
                                @if (log.IsDnssec)
                                {
                                    <span class="badge bg-primary">
                                        <span class="bi bi-shield-check me-1"></span> DNSSEC
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted small">None</span>
                                }
                            </td>
                            <td>
                                <span class="badge @(log.Status == "Blocked" ? "bg-danger" : "bg-success")">
                                    @log.Status
                                </span>
                            </td>
                            <td>
                                @if (log.Status == "Blocked")
                                {
                                    <button class="btn btn-sm btn-outline-success" @onclick="() => WhitelistDomain(log.Domain)">
                                        <span class="bi bi-shield-check"></span> Whitelist
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => BlacklistDomain(log.Domain)">
                                        <span class="bi bi-shield-slash"></span> Blacklist
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="card-footer bg-white border-top d-flex justify-content-between align-items-center py-3">
            <div class="small text-muted">
                Showing page <strong>@((PageIndex ?? 0) + 1)</strong> of <strong>@TotalPages</strong> (@TotalCount total)
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="input-group input-group-sm" style="width: 150px;">
                    <span class="input-group-text">Go to</span>
                    <input type="number" class="form-control" min="1" max="@TotalPages" @bind="JumpPage" @bind:event="oninput" @onchange="HandleJumpToPage" />
                </div>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm" disabled="@(PageIndex == 0)" @onclick="PreviousPage">
                        <span class="bi bi-chevron-left"></span> Previous
                    </button>
                    <button class="btn btn-outline-primary btn-sm" disabled="@(PageIndex >= TotalPages - 1)" @onclick="NextPage">
                        Next <span class="bi bi-chevron-right"></span>
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "ip")]
    public string? SearchIP { get; set; }
    
    private string? SearchTerm { get; set; }
    private string StatusFilter { get; set; } = "All";
    private DateTime StartDate { get; set; } = DateTime.Today;
    private DateTime EndDate { get; set; } = DateTime.Today.AddDays(1);

    private int PageIndex { get; set; } = 0;
    private int TotalPages { get; set; } = 1;
    private int TotalCount { get; set; } = 0;
    private int JumpPage { get; set; } = 1;
    private const int PageSize = 50;

    private List<QueryLog>? logs;
    private Dictionary<string, DeviceInfo> devices = new();

    protected override async Task OnInitializedAsync()
    {
        // Load logs for today by default
        await LoadLogs();
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            PageIndex = 0;
            await LoadLogs();
        }
    }

    private async Task LoadLogs()
    {
        var query = Db.QueryLogs.AsQueryable();

        // Date range filter
        query = query.Where(l => l.Timestamp >= StartDate && l.Timestamp < EndDate);

        if (StatusFilter != "All")
        {
            query = query.Where(l => l.Status == StatusFilter);
        }

        if (!string.IsNullOrEmpty(SearchIP))
        {
            query = query.Where(l => l.SourceIP == SearchIP);
        }

        if (!string.IsNullOrEmpty(SearchTerm))
        {
            query = query.Where(l => l.Domain.Contains(SearchTerm));
        }

        TotalCount = await query.CountAsync();
        TotalPages = (int)Math.Ceiling((double)TotalCount / PageSize);
        if (TotalPages == 0) TotalPages = 1;
        JumpPage = PageIndex + 1;

        logs = await query
            .OrderByDescending(x => x.Id)
            .Skip(PageIndex * PageSize)
            .Take(PageSize)
            .ToListAsync();

        // Load devices for names
        var deviceIds = logs.Where(x => x.ClientId != null).Select(x => x.ClientId).Distinct().ToList();
        devices = await Db.Devices.Where(x => deviceIds.Contains(x.Id)).ToDictionaryAsync(x => x.Id);
    }

    private async Task HandleJumpToPage()
    {
        if (JumpPage >= 1 && JumpPage <= TotalPages)
        {
            PageIndex = JumpPage - 1;
            await LoadLogs();
        }
    }

    private async Task NextPage()
    {
        PageIndex++;
        await LoadLogs();
    }

    private async Task PreviousPage()
    {
        if (PageIndex > 0)
        {
            PageIndex--;
            await LoadLogs();
        }
    }

    private async Task ClearLogs()
    {
        Db.QueryLogs.RemoveRange(Db.QueryLogs);
        await Db.SaveChangesAsync();
        await LoadLogs();
    }

    private async Task WhitelistDomain(string domain)
    {
        if (!await Db.WhitelistedDomains.AnyAsync(x => x.Domain == domain))
        {
            Db.WhitelistedDomains.Add(new WhitelistedDomain 
            { 
                Domain = domain, 
                AddedAt = DateTime.Now 
            });
            await Db.SaveChangesAsync();
            await DnsWorker.RefreshWhitelistAsync();
            await LoadLogs();
        }
    }

    private async Task BlacklistDomain(string domain)
    {
        if (!await Db.BlacklistedDomains.AnyAsync(x => x.Domain == domain))
        {
            Db.BlacklistedDomains.Add(new BlacklistedDomain
            {
                Domain = domain,
                Reason = "Manual block from Query Logs",
                AddedAt = DateTime.UtcNow
            });
            await Db.SaveChangesAsync();
            await DnsWorker.RefreshBlacklistAsync();
            await LoadLogs();
        }
    }

    private string GetRowClass(string status)
    {
        return status == "Blocked" ? "table-danger opacity-75" : "";
    }
}
