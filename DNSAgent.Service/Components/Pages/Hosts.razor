@page "/hosts"
@rendermode InteractiveServer
@using DNSAgent.Service.Data
@using Microsoft.EntityFrameworkCore
@inject DnsDbContext Db

<PageTitle>Hosts Analytics - DNS Agent</PageTitle>

<div class="container mt-4">
    <div class="row mb-4 align-items-center">
        <div class="col-md-6">
            <h1>Hosts Analytics</h1>
            <p class="text-muted">Query distribution across your network</p>
        </div>
        <div class="col-md-3">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0">
                    <span class="bi bi-filter"></span>
                </span>
                <select class="form-select border-start-0" @bind="StatusFilter" @bind:event="onchange">
                    <option value="All">All Status</option>
                    <option value="Blocked">Blocked Only</option>
                    <option value="Allowed">Allowed Only</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="input-group shadow-sm">
                <span class="input-group-text bg-white border-end-0">
                    <span class="bi bi-search"></span>
                </span>
                <input type="text" class="form-control border-start-0" 
                       placeholder="Filter by IP..." 
                       @bind="SearchTerm" @bind:event="oninput" />
            </div>
        </div>
    </div>

    @if (hostStats == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover shadow-sm">
                <thead>
                    <tr class="table-primary text-white">
                        <th>Host / Machine Name</th>
                        <th>User</th>
                        <th>Total Queries</th>
                        <th>Blocked</th>
                        <th>Allowed</th>
                        <th>Block Rate</th>
                        <th>Last Activity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var host in FilteredStats)
                    {
                        <tr>
                            <td>
                                <div><strong>@(string.IsNullOrEmpty(host.MachineName) ? host.Hostname : host.MachineName)</strong></div>
                                <small class="text-muted">@host.IP</small>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(host.UserName))
                                {
                                    <span class="badge bg-info text-dark">
                                        <span class="bi bi-person me-1"></span> @host.UserName
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted small">Unknown</span>
                                }
                            </td>
                            <td>@host.TotalQueries</td>
                            <td>
                                <span class="badge bg-danger">@host.BlockedQueries</span>
                            </td>
                            <td>
                                <span class="badge bg-success">@host.AllowedQueries</span>
                            </td>
                            <td>
                                <div class="progress" style="height: 10px; margin-top: 5px;">
                                    <div class="progress-bar bg-danger" role="progressbar" 
                                         style="width: @(host.BlockRate)%" 
                                         aria-valuenow="@host.BlockRate" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <small>@(host.BlockRate.ToString("0.0"))%</small>
                            </td>
                            <td>@host.LastSeen.ToString("HH:mm:ss")</td>
                            <td>
                               <a href="logs?ip=@host.IP" class="btn btn-sm btn-outline-primary">
                                   <span class="bi bi-search"></span> View Logs
                               </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<HostStat>? hostStats;
    private string SearchTerm = "";
    private string StatusFilter = "All";

    private List<HostStat> FilteredStats => hostStats?
        .Where(h => (string.IsNullOrWhiteSpace(SearchTerm) || 
                   h.IP.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) || 
                   h.Hostname.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)) &&
                   (StatusFilter == "All" || 
                    (StatusFilter == "Blocked" && h.BlockedQueries > 0) || 
                    (StatusFilter == "Allowed" && h.AllowedQueries > 0)))
        .ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        var logs = await Db.QueryLogs
            .GroupBy(l => l.SourceIP)
            .Select(g => new
            {
                IP = g.Key,
                Hostname = g.OrderByDescending(x => x.Timestamp).Select(x => x.SourceHostname).FirstOrDefault(),
                ClientId = g.OrderByDescending(x => x.Timestamp).Select(x => x.ClientId).FirstOrDefault(),
                TotalQueries = g.Count(),
                BlockedQueries = g.Count(l => l.Status == "Blocked"),
                AllowedQueries = g.Count(l => l.Status == "Allowed"),
                LastSeen = g.Max(l => l.Timestamp)
            })
            .ToListAsync();

        var devices = await Db.Devices.ToDictionaryAsync(d => d.Id);

        hostStats = logs.Select(l => new HostStat
        {
            IP = l.IP,
            Hostname = l.Hostname ?? l.IP,
            MachineName = (l.ClientId != null && devices.TryGetValue(l.ClientId, out var d)) ? d.MachineName : "",
            UserName = (l.ClientId != null && devices.TryGetValue(l.ClientId, out var u)) ? u.UserName : "",
            TotalQueries = l.TotalQueries,
            BlockedQueries = l.BlockedQueries,
            AllowedQueries = l.AllowedQueries,
            LastSeen = l.LastSeen
        })
        .OrderByDescending(h => h.TotalQueries)
        .ToList();
    }

    public class HostStat
    {
        public string IP { get; set; } = "";
        public string Hostname { get; set; } = "";
        public string MachineName { get; set; } = "";
        public string UserName { get; set; } = "";
        public int TotalQueries { get; set; }
        public int BlockedQueries { get; set; }
        public int AllowedQueries { get; set; }
        public double BlockRate => TotalQueries == 0 ? 0 : (double)BlockedQueries / TotalQueries * 100;
        public DateTime LastSeen { get; set; }
    }
}
