@page "/"
@rendermode InteractiveServer
@using DNSAgent.Service.Data
@using Microsoft.EntityFrameworkCore
@inject DnsDbContext Db
@implements IDisposable

<PageTitle>DNS Agent Dashboard</PageTitle>


<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1>DNS Agent Dashboard</h1>
            <p class="text-muted">Real-time network protection stats</p>
        </div>
    </div>

    <div class="row">
        <!-- Total Queries -->
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Total Queries (24h)</div>
                <div class="card-body">
                    <h2 class="card-title">@_stats.TotalQueries</h2>
                </div>
            </div>
        </div>

        <!-- Blocked Queries -->
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Blocked (24h)</div>
                <div class="card-body">
                    <h2 class="card-title">@_stats.BlockedQueries</h2>
                    <p class="card-text">@_stats.BlockedPercentage.ToString("0.0")%</p>
                </div>
            </div>
        </div>

        <!-- YouTube Ads Blocked -->
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">YouTube Ads Blocked</div>
                <div class="card-body">
                    <h2 class="card-title">@_stats.YouTubeAdsBlocked</h2>
                    <p class="card-text">Total across network</p>
                </div>
            </div>
        </div>

        <!-- Time Saved -->
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">YouTube Time Saved</div>
                <div class="card-body">
                    <h2 class="card-title">@FormatTime(_stats.TimeSavedSeconds)</h2>
                    <p class="card-text">Sponsors skipped: @_stats.SponsorsSkipped</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-2 mb-4">
        <div class="col-12 text-center">
            <a href="admin/youtube-stats" class="btn btn-outline-primary btn-sm">View Detailed YouTube Stats ðŸ“Š</a>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <button class="btn btn-primary" @onclick="RefreshStats">Refresh Stats</button>
        </div>
    </div>
</div>

@code {
    private DashboardStats _stats = new();
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await RefreshStats();
        // Auto-refresh every 5 seconds
        _timer = new System.Threading.Timer(async _ => 
        {
            await InvokeAsync(async () => 
            {
                await RefreshStats();
                StateHasChanged();
            });
        }, null, 5000, 5000);
    }

    private async Task RefreshStats()
    {
        try
        {
            var since = DateTime.Now.AddHours(-24);
            
            // DNS Stats
            var queries = await Db.QueryLogs
                .Where(x => x.Timestamp >= since)
                .Select(x => x.Status)
                .ToListAsync();

            _stats.TotalQueries = queries.Count;
            _stats.BlockedQueries = queries.Count(s => s == "Blocked");
            _stats.AllowedQueries = queries.Count(s => s == "Allowed");

            // YouTube Stats
            try 
            {
                _stats.YouTubeAdsBlocked = await Db.YouTubeStats.SumAsync(s => s.AdsBlocked);
                _stats.SponsorsSkipped = await Db.YouTubeStats.SumAsync(s => s.SponsorsSkipped);
                _stats.TimeSavedSeconds = await Db.YouTubeStats.SumAsync(s => s.TimeSavedSeconds);
            }
            catch { /* Table might not exist yet */ }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stats: {ex.Message}");
            _stats = new DashboardStats();
        }
    }

    private string FormatTime(double seconds)
    {
        if (seconds < 60) return $"{seconds:F0}s";
        if (seconds < 3600) return $"{seconds / 60:F1}m";
        return $"{seconds / 3600:F1}h";
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }

    public class DashboardStats
    {
        public int TotalQueries { get; set; }
        public int BlockedQueries { get; set; }
        public int AllowedQueries { get; set; }
        public int YouTubeAdsBlocked { get; set; }
        public int SponsorsSkipped { get; set; }
        public double TimeSavedSeconds { get; set; }
        public double BlockedPercentage => TotalQueries == 0 ? 0 : (double)BlockedQueries / TotalQueries * 100;
    }
}
