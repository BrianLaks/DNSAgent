@rendermode InteractiveServer
@inject IJSRuntime JS
@page "/help"

<PageTitle>Setup & Help - DNS Agent</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h1 class="mb-4">Setup & Help Guide üìñ</h1>
            
            <div class="accordion" id="helpAccordion">
                <!-- Installation Guide -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#installGuide">
                            <span class="bi bi-download me-2"></span> üöÄ Quick Installation
                        </button>
                    </h2>
                    <div id="installGuide" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>Installation is designed to be simple and automated.</p>
                            <ol>
                                <li>Extract the <strong>DNSAgent.zip</strong> contents to a permanent folder.</li>
                                <li>Right-click <strong>Start-Setup.bat</strong> and select <strong>Run as Administrator</strong>.</li>
                                <li>The setup will automatically:
                                    <ul>
                                        <li>Register the Windows Service.</li>
                                        <li>Open Firewall ports (5123 and 53).</li>
                                        <li>Configure the System Tray icon for auto-start.</li>
                                    </ul>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Firewall Troubleshooting -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#troubleshootHelp">
                            <span class="bi bi-shield-lock me-2"></span> üî• Firewall & Access Issues
                        </button>
                    </h2>
                    <div id="troubleshootHelp" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>If you cannot reach this dashboard from your phone or another PC, the Windows Firewall might be blocking the connection.</p>
                            <p>Run this command in an <strong>Administrator PowerShell</strong> on the server to open the ports manually:</p>
                            <div class="bg-dark p-3 rounded position-relative">
                                <pre class="text-warning mb-0" id="fwScript"><code>New-NetFirewallRule -DisplayName "DNS Agent Web" -Direction Inbound -LocalPort 5123 -Protocol TCP -Action Allow; 
New-NetFirewallRule -DisplayName "DNS Agent DNS" -Direction Inbound -LocalPort 53 -Protocol UDP,TCP -Action Allow</code></pre>
                                <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" @onclick="CopyFwScript">
                                    <span class="bi bi-clipboard"></span> Copy
                                </button>
                            </div>
                            <p class="mt-3 small text-muted"><strong>Required Ports:</strong> Port 5123 (TCP) for Web UI, Port 53 (UDP/TCP) for DNS queries.</p>
                        </div>
                    </div>
                </div>

                <!-- Service Troubleshooting -->
                <div class="accordion-item shadow-sm border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#serviceHelp">
                            <span class="bi bi-gear-fill me-2"></span> üõ†Ô∏è Manual Service Controls
                        </button>
                    </h2>
                    <div id="serviceHelp" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>For advanced management, use the <strong>install-service.ps1</strong> script:</p>
                            <ul>
                                <li><code>.\install-service.ps1 install</code> - Fully registers and starts the service.</li>
                                <li><code>.\install-service.ps1 uninstall</code> - Safely removes the service.</li>
                            </ul>
                            <div class="alert alert-warning py-2">
                                <small><strong>Tip:</strong> Always run these from an Administrator command prompt!</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string CurrentIP = "Loading...";

    protected override void OnInitialized()
    {
        try 
        {
            var host = System.Net.Dns.GetHostEntry(System.Net.Dns.GetHostName());
            CurrentIP = host.AddressList.FirstOrDefault(ip => ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)?.ToString() ?? "127.0.0.1";
        }
        catch
        {
            CurrentIP = "127.0.0.1";
        }
    }

    private async Task CopyScript()
    {
        var script = "$dnsServer = \"" + CurrentIP + "\"\r\n" +
                    "$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq \"Connected\" }\r\n" +
                    "foreach ($interface in $interfaces) {\r\n" +
                    "    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer\r\n" +
                    "    Write-Host \"DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)\"\r\n" +
                    "}";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }

    private async Task CopyFwScript()
    {
        var script = "New-NetFirewallRule -DisplayName \"DNS Agent Web\" -Direction Inbound -LocalPort 5123 -Protocol TCP -Action Allow; \r\n" +
                     "New-NetFirewallRule -DisplayName \"DNS Agent DNS\" -Direction Inbound -LocalPort 53 -Protocol UDP,TCP -Action Allow";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }
}
