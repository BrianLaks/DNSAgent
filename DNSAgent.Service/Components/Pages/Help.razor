@rendermode InteractiveServer
@inject IJSRuntime JS
@page "/help"

<PageTitle>Setup & Help - DNS Agent</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h1 class="mb-4">Setup & Help Guide üìñ</h1>
            
            <div class="accordion" id="helpAccordion">
                <!-- Client Visibility Guide -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#clientVisibility">
                            <span class="bi bi-eye me-2"></span> üîç Seeing Individual Device IPs
                        </button>
                    </h2>
                    <div id="clientVisibility" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>Are you only seeing your **Router's IP** in the logs? This is normal if your router is acting as a "middleman" (DNS Proxy).</p>
                            
                            <h6 class="fw-bold">Why this happens:</h6>
                            <p class="small text-muted">When you set the DNS at the router level, some routers take the query from the PC, ask DNS Agent themselves, and then give the answer back. DNS Agent only "sees" the router making the request.</p>
                            
                            <h6 class="fw-bold">How to see individual device names:</h6>
                            <p>To see exactly which PC is making which request, you must point that device <strong>directly</strong> to this server's IP (<code>@CurrentIP</code>) instead of the router.</p>
                            
                            <div class="alert alert-primary py-2 mt-2">
                                <span class="bi bi-info-circle me-1"></span>
                                <small>Use the <strong>"PC Setup Script"</strong> below on each computer to enable per-device logging!</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual PC Setup -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#manualSetup">
                            <span class="bi bi-pc-display me-2"></span> üíª PC Setup Script (Direct Logging)
                        </button>
                    </h2>
                    <div id="manualSetup" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>Run this PowerShell script (as Administrator) on any Windows machine to point it directly to this server. This ensures the dashboard can identify this specific PC.</p>
                            
                            <div class="bg-dark p-3 rounded position-relative">
                                <pre class="text-success mb-0" id="psScript"><code>$dnsServer = "@CurrentIP"
$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq "Connected" }
foreach ($interface in $interfaces) {
    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer
    Write-Host "DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)"
}</code></pre>
                                <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" @onclick="CopyScript">
                                    <span class="bi bi-clipboard"></span> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string CurrentIP = "Loading...";

    protected override void OnInitialized()
    {
        try 
        {
            var host = System.Net.Dns.GetHostEntry(System.Net.Dns.GetHostName());
            CurrentIP = host.AddressList.FirstOrDefault(ip => ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)?.ToString() ?? "127.0.0.1";
        }
        catch
        {
            CurrentIP = "127.0.0.1";
        }
    }

    private async Task CopyScript()
    {
        var script = "$dnsServer = \"" + CurrentIP + "\"\r\n" +
                    "$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq \"Connected\" }\r\n" +
                    "foreach ($interface in $interfaces) {\r\n" +
                    "    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer\r\n" +
                    "    Write-Host \"DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)\"\r\n" +
                    "}";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }

    private async Task CopyFwScript()
    {
        var script = "New-NetFirewallRule -DisplayName \"DNS Agent Web\" -Direction Inbound -LocalPort 5123 -Protocol TCP -Action Allow; \r\n" +
                     "New-NetFirewallRule -DisplayName \"DNS Agent DNS\" -Direction Inbound -LocalPort 53 -Protocol UDP,TCP -Action Allow";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }
}
