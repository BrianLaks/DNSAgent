@rendermode InteractiveServer
@inject IJSRuntime JS
@page "/help"

<PageTitle>The Network Guardian - DNS Agent</PageTitle>

<div class="container mt-4 pb-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Mastery Header -->
            <div class="text-center mb-5">
                <i class="bi bi-shield-check text-primary" style="font-size: 4rem;"></i>
                <h1 class="display-4 fw-bold">DNS Agent: Network Guardian</h1>
                <p class="lead text-muted">A world-class defense system that protects your entire home from within your browser.</p>
            </div>

            <!-- THE BIG 3 FEATURES (The Sell) -->
            <div class="row mb-5 g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-eye-slash text-indigo mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Proactive Sentinel</h5>
                            <p class="small text-muted">While other tools wait for "lists" to update, our Sentinel extension identifies trackers <em>live</em> and kills them instantly network-wide.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-cpu text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Zero-Device Left Behind</h5>
                            <p class="small text-muted">Smart TVs and IoT devices can't run adblockers. Our system protects them by sanitizing their DNS queries at the source.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-shield-lock text-info mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">DNSSEC Integrity</h5>
                            <p class="small text-muted">We don't just block; we verify. Every query is cryptographically checked to ensure you aren't being redirected by hackers.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="mb-4">Master Setup & Help Guide üìñ</h2>
            
            <div class="accordion" id="helpAccordion">
                <!-- Why it's better -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#superiority">
                            <span class="bi bi-trophy me-2 text-warning"></span> üëë Why DNS Agent Beats piHole/AdGuard
                        </button>
                    </h2>
                    <div id="superiority" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <div class="p-3 border rounded bg-light h-100">
                                        <h6 class="fw-bold"><i class="bi bi-browser-chrome me-2"></i> Browser Integration</h6>
                                        <p class="small mb-0">Unlike standard DNS servers, we have a "Sentinel" in your browser. It tells the DNS server about trackers that standard lists haven't even seen yet.</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="p-3 border rounded bg-light h-100">
                                        <h6 class="fw-bold"><i class="bi bi-radar me-2"></i> Bypass Detection</h6>
                                        <p class="small mb-0">If a device or app tries to bypass your DNS using Hardcoded IPs or DoH, we <strong>detect and log it</strong> immediately on your dashboard.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Installation: The Professional Way (Scripted) -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-success">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#installerHelp">
                            <span class="bi bi-rocket-takeoff me-2 text-success"></span> Step 1: Install the Network Shield
                        </button>
                    </h2>
                    <div id="installerHelp" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>To register the DNS Agent as a Windows Service and open the required firewall ports:</p>
                            <div class="p-3 bg-light border rounded mb-3">
                                <h6 class="fw-bold"><i class="bi bi-terminal me-2"></i> Automated Setup (Recommended)</h6>
                                <ol class="small mb-0">
                                    <li>Extract the release ZIP to a permanent folder (e.g., <code>C:\Programs\DNSAgent</code>).</li>
                                    <li>Right-click <strong>Start-Setup.bat</strong> and select <strong>Run as Administrator</strong>.</li>
                                    <li>The script will automatically handle service registration, firewall rules, and process cleanup.</li>
                                </ol>
                            </div>
                            <div class="alert alert-info py-2 small">
                                <i class="bi bi-info-circle me-1"></i> <strong>Data Preservation</strong>: The setup script will detect and preserve your existing <code>dnsagent.db</code> automatically during upgrades.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Router Configuration (Network Wide) -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-indigo">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#routerHelp">
                            <span class="bi bi-router me-2 text-indigo"></span> Step 2: Configure Router (Network Wide)
                        </button>
                    </h2>
                    <div id="routerHelp" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <div class="alert alert-warning py-3 mb-3">
                                <h6 class="fw-bold mb-1"><i class="bi bi-exclamation-triangle-fill me-2"></i> Critical Distinction: WAN vs LAN</h6>
                                <p class="small mb-0">Don't just change the "Internet" DNS. You must change the <strong>DHCP / LAN DNS</strong> to see individual devices (TVs, Phones) in your dashboard.</p>
                            </div>

                            <p class="small">Enter your Router's Admin Panel (usually <code>192.168.1.1</code>) and find the **DHCP Server** settings.</p>

                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <div class="p-3 bg-light border rounded h-100">
                                        <h6 class="fw-bold text-primary">Netgear Nighthawk ü¶Ö</h6>
                                        <ol class="small ps-3 mb-0">
                                            <li>Go to <strong>Advanced</strong> tab.</li>
                                            <li>Select <strong>Setup</strong> &gt; <strong>LAN Setup</strong>.</li>
                                            <li>Under "Use these DNS Servers", enter:
                                                <ul>
                                                    <li><strong>Secondary:</strong> <code>1.1.1.1</code> (Backup)</li> 
                                                    <li><strong>Primary:</strong> <code>@CurrentIP</code> (This Server)</li>
                                                </ul>
                                            </li>
                                            <li>Click <strong>Apply</strong>.</li>
                                        </ol>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="p-3 bg-light border rounded h-100">
                                        <h6 class="fw-bold text-danger">ASUS / TP-Link / Linksys</h6>
                                        <ol class="small ps-3 mb-0">
                                            <li>Look for <strong>DHCP Server</strong> or <strong>LAN Settings</strong>.</li>
                                            <li>Find <strong>DNS Server</strong> fields.</li>
                                            <li>Ensure you are <strong>NOT</strong> in "WAN" or "Internet" settings.</li>
                                            <li>Set Primary DNS to <code>@CurrentIP</code>.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Establish the Sentinel -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-primary">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#extensionSetup">
                            <span class="bi bi-plugin me-2 text-primary"></span> Step 2: Establish the Sentinel (Browser)
                        </button>
                    </h2>
                    <div id="extensionSetup" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>To enable <strong>Real-time Tracker Detection</strong> and advanced YouTube filtering, install the extension on your PC:</p>
                            <div class="d-flex align-items-center mb-3">
                                <a href="/api/download/extension" class="btn btn-primary me-3">
                                    <i class="bi bi-download me-1"></i> Get Extension v2.4.3
                                </a>
                                <span class="badge bg-info">Auto-packaged for this server</span>
                            </div>
                            <small class="text-muted d-block mb-2">Instructions:</small>
                            <ol class="small text-muted">
                                <li>Download and extract the ZIP.</li>
                                <li>Visit <code>brave://extensions</code> (or <code>chrome://extensions</code>) and enable "Developer Mode".</li>
                                <li>Use "Load Unpacked" and select the extension folder.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- YouTube & SmartTube -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-danger">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#youtubeHelp">
                            <span class="bi bi-youtube me-2 text-danger"></span> Step 3: YouTube Insights & SmartTube (Android/TV)
                        </button>
                    </h2>
                    <div id="youtubeHelp" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <div class="alert alert-danger py-3 mb-4">
                                <h6 class="fw-bold mb-1"><i class="bi bi-android me-2"></i> Using a Smart TV or Android Device?</h6>
                                <p class="small mb-2">Standard apps often bypass DNS. Use our specialized guide to install SmartTube and sync it with this dashboard.</p>
                                <a href="https://github.com/BrianLaks/DNSAgent/blob/main/SMARTTUBE_GUIDE.md" target="_blank" class="btn btn-sm btn-danger">View SmartTube Guide</a>
                            </div>

                            <h6 class="fw-bold">Algorithm Circumvention Layer</h6>
                            <p class="small">YouTube's algorithm often shows you content you've already seen. Our system uses your <em>local</em> history to surgically modify the YouTube interface:</p>
                            <ul class="small">
                                <li><strong>Hide Watched</strong>: Search results automatically hide videos you've already finished.</li>
                                <li><strong>Boost Trusted</strong>: Channels you watch frequently are prioritized and badged.</li>
                                <li><strong>User Isolation</strong>: Detects your YouTube Handle (e.g. <code>@@brianlaks</code>) so results aren't polluted by others.</li>
                            </ul>

                            <hr />

                            <h6 class="fw-bold">The "Proxy Trick" (For TVs)</h6>
                            <p class="small">Capture watch history from Smart TVs without needing an extension by proxying the SponsorBlock API:</p>
                            <div class="p-3 bg-light border rounded">
                                <ol class="small mb-0">
                                    <li>In SmartTube: Settings > SponsorBlock > <strong>API URL</strong>.</li>
                                    <li>Change to: <code>http://@CurrentIP:5123/api/sponsorblock/</code></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Community & Open Source -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-success">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#communityHelp">
                            <span class="bi bi-github me-2 text-dark"></span> ü§ù Community & Contribution Portal
                        </button>
                    </h2>
                    <div id="communityHelp" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p class="small"><strong>DNS Agent</strong> is an open source project built on the philosophy of network transparency and user sovereignty. We welcome contributions, bug reports, and feature requests from the community.</p>
                            
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="p-3 border rounded text-center bg-light h-100">
                                        <i class="bi bi-bug text-danger fs-3 mb-2 d-block"></i>
                                        <h6 class="fw-bold">Report a Bug</h6>
                                        <p class="small text-muted mb-2">Found a tracker getting through? Crashed on startup?</p>
                                        <a href="https://github.com/BrianLaks/DNSAgent/issues/new" target="_blank" class="btn btn-sm btn-outline-danger w-100">Open Bug Report</a>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border rounded text-center bg-light h-100">
                                        <i class="bi bi-lightbulb text-warning fs-3 mb-2 d-block"></i>
                                        <h6 class="fw-bold">Request a Feature</h6>
                                        <p class="small text-muted mb-2">Have an idea for a new YouTube filter or UI enhancement?</p>
                                        <a href="https://github.com/BrianLaks/DNSAgent/issues/new" target="_blank" class="btn btn-sm btn-outline-warning w-100">Submit Request</a>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 border rounded text-center bg-light h-100">
                                        <i class="bi bi-git text-primary fs-3 mb-2 d-block"></i>
                                        <h6 class="fw-bold">Pull Requests</h6>
                                        <p class="small text-muted mb-2">Ready to contribute code? Fork us on GitHub!</p>
                                        <a href="https://github.com/BrianLaks/DNSAgent/pulls" target="_blank" class="btn btn-sm btn-outline-primary w-100">Join the Dev Team</a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 border-top">
                                <h6 class="fw-bold"><i class="bi bi-chat-quote me-2"></i> Our Mission</h6>
                                <p class="small text-muted mb-0">We believe that your network data belongs to <strong>you</strong>. By making this a community-driven project, we ensure that the "Sentinel" is always ahead of corporate tracking and algorithmic manipulation.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Community Link -->
            <div class="text-center mt-5 mb-5 opacity-75">
                <p class="small text-muted">DNS Agent is an Open Source Project</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="https://github.com/BrianLaks/DNSAgent" target="_blank" class="text-reset text-decoration-none">
                        <i class="bi bi-github me-1"></i> GitHub Repo
                    </a>
                    <span class="text-muted">|</span>
                    <a href="https://github.com/BrianLaks/DNSAgent/discussions" target="_blank" class="text-reset text-decoration-none">
                        <i class="bi bi-people me-1"></i> Community Portal
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string CurrentIP = "Loading...";

    protected override void OnInitialized()
    {
        try 
        {
            var host = System.Net.Dns.GetHostEntry(System.Net.Dns.GetHostName());
            CurrentIP = host.AddressList.FirstOrDefault(ip => ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)?.ToString() ?? "127.0.0.1";
        }
        catch
        {
            CurrentIP = "127.0.0.1";
        }
    }

    private async Task CopyScript()
    {
        var script = "$dnsServer = \"" + CurrentIP + "\"\r\n" +
                    "$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq \"Connected\" }\r\n" +
                    "foreach ($interface in $interfaces) {\r\n" +
                    "    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer\r\n" +
                    "    Write-Host \"DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)\"\r\n" +
                    "}";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }

    private async Task CopyFwScript()
    {
        var script = "New-NetFirewallRule -DisplayName \"DNS Agent Web\" -Direction Inbound -LocalPort 5123 -Protocol TCP -Action Allow; \r\n" +
                     "New-NetFirewallRule -DisplayName \"DNS Agent DNS\" -Direction Inbound -LocalPort 53 -Protocol UDP,TCP -Action Allow";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }
}
