@rendermode InteractiveServer
@inject IJSRuntime JS
@page "/help"

<PageTitle>The Network Guardian - DNS Agent</PageTitle>

<div class="container mt-4 pb-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Mastery Header -->
            <div class="text-center mb-5">
                <i class="bi bi-shield-check text-primary" style="font-size: 4rem;"></i>
                <h1 class="display-4 fw-bold">DNS Agent: Network Guardian</h1>
                <p class="lead text-muted">A world-class defense system that protects your entire home from within your browser.</p>
            </div>

            <!-- THE BIG 3 FEATURES (The Sell) -->
            <div class="row mb-5 g-4">
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-eye-slash text-indigo mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Proactive Sentinel</h5>
                            <p class="small text-muted">While other tools wait for "lists" to update, our Sentinel extension identifies trackers <em>live</em> and kills them instantly network-wide.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-cpu text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Zero-Device Left Behind</h5>
                            <p class="small text-muted">Smart TVs and IoT devices can't run adblockers. Our system protects them by sanitizing their DNS queries at the source.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 shadow-sm card-animate p-3 text-center">
                        <div class="card-body">
                            <i class="bi bi-shield-lock text-info mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">DNSSEC Integrity</h5>
                            <p class="small text-muted">We don't just block; we verify. Every query is cryptographically checked to ensure you aren't being redirected by hackers.</p>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="mb-4">Master Setup & Help Guide ðŸ“–</h2>
            
            <div class="accordion" id="helpAccordion">
                <!-- Why it's better -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#superiority">
                            <span class="bi bi-trophy me-2 text-warning"></span> ðŸ‘‘ Why DNS Agent Beats piHole/AdGuard
                        </button>
                    </h2>
                    <div id="superiority" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <div class="p-3 border rounded bg-light h-100">
                                        <h6 class="fw-bold"><i class="bi bi-browser-chrome me-2"></i> Browser Integration</h6>
                                        <p class="small mb-0">Unlike standard DNS servers, we have a "Sentinel" in your browser. It tells the DNS server about trackers that standard lists haven't even seen yet.</p>
                                    </div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="p-3 border rounded bg-light h-100">
                                        <h6 class="fw-bold"><i class="bi bi-radar me-2"></i> Bypass Detection</h6>
                                        <p class="small mb-0">If a device or app tries to bypass your DNS using Hardcoded IPs or DoH, we <strong>detect and log it</strong> immediately on your dashboard.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Setup Steps -->
                <div class="accordion-item shadow-sm mb-3 border-0 border-start border-4 border-primary">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#extensionSetup">
                            <span class="bi bi-plugin me-2 text-primary"></span> Step 1: Establish the Sentinel
                        </button>
                    </h2>
                    <div id="extensionSetup" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>To enable <strong>Real-time Tracker Detection</strong>, you must install the Browser Extension:</p>
                            <div class="d-flex align-items-center mb-3">
                                <a href="/api/download/extension" class="btn btn-primary me-3">
                                    <i class="bi bi-download me-1"></i> Get Extension v2.4+
                                </a>
                                <span class="badge bg-info">Auto-packaged for this server</span>
                            </div>
                            <small class="text-muted d-block mb-2">Instructions:</small>
                            <ol class="small text-muted">
                                <li>Download and extract the ZIP.</li>
                                <li>Visit <code>brave://extensions</code> and enable "Developer Mode".</li>
                                <li>Use "Load Unpacked" and select the extension folder.</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Manual PC Setup -->
                <div class="accordion-item shadow-sm mb-3 border-0">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#manualSetup">
                            <span class="bi bi-pc-display me-2"></span> ðŸ’» Per-Device Shield Setup
                        </button>
                    </h2>
                    <div id="manualSetup" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                        <div class="accordion-body">
                            <p>To see <strong>Machine Names</strong> instead of just Router IPs, run this script as Admin on each PC:</p>
                            <div class="bg-dark p-3 rounded position-relative">
                                <pre class="text-success mb-0" style="font-size: 0.8rem;"><code>$dnsServer = "@CurrentIP"
$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq "Connected" }
foreach ($interface in $interfaces) {
    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer
    Write-Host "DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)"
}</code></pre>
                                <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" @onclick="CopyScript">
                                    <span class="bi bi-clipboard"></span> Copy
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string CurrentIP = "Loading...";

    protected override void OnInitialized()
    {
        try 
        {
            var host = System.Net.Dns.GetHostEntry(System.Net.Dns.GetHostName());
            CurrentIP = host.AddressList.FirstOrDefault(ip => ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork)?.ToString() ?? "127.0.0.1";
        }
        catch
        {
            CurrentIP = "127.0.0.1";
        }
    }

    private async Task CopyScript()
    {
        var script = "$dnsServer = \"" + CurrentIP + "\"\r\n" +
                    "$interfaces = Get-NetIPInterface -AddressFamily IPv4 | Where-Object { $_.ConnectionState -eq \"Connected\" }\r\n" +
                    "foreach ($interface in $interfaces) {\r\n" +
                    "    Set-DnsClientServerAddress -InterfaceIndex $interface.InterfaceIndex -ServerAddresses $dnsServer\r\n" +
                    "    Write-Host \"DNS updated to $dnsServer for interface: $($interface.InterfaceAlias)\"\r\n" +
                    "}";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }

    private async Task CopyFwScript()
    {
        var script = "New-NetFirewallRule -DisplayName \"DNS Agent Web\" -Direction Inbound -LocalPort 5123 -Protocol TCP -Action Allow; \r\n" +
                     "New-NetFirewallRule -DisplayName \"DNS Agent DNS\" -Direction Inbound -LocalPort 53 -Protocol UDP,TCP -Action Allow";
        await JS.InvokeVoidAsync("clipboardCopy.copyText", script);
    }
}
